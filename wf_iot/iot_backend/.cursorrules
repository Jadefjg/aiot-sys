# IoT Backend System - Cursor Rules

## 项目概述
这是一个基于FastAPI的IoT后端系统，提供设备管理、用户管理、固件升级、MQTT通信等功能。

## 技术栈
- **后端框架**: FastAPI 0.104.1
- **数据库**: MySQL 8.0 + SQLAlchemy 2.0.23
- **缓存**: Redis 5.0.1
- **消息队列**: Celery 5.3.4 + Redis
- **MQTT通信**: paho-mqtt 1.6.1
- **认证**: JWT (python-jose + passlib)
- **数据库迁移**: Alembic 1.12.1
- **容器化**: Docker + Docker Compose

## 项目结构
```
app/
├── api/v1/          # API路由层
│   ├── endpoints/   # 具体端点实现
│   └── api.py       # 路由聚合
├── core/            # 核心配置和依赖
├── crud/            # 数据访问层
├── db/              # 数据库相关
│   └── models/      # SQLAlchemy模型
├── schemas/         # Pydantic模型
├── services/        # 业务逻辑层
├── tasks/           # Celery异步任务
└── utils/           # 工具函数
```

## 编码规范

### 1. 代码风格
- 使用中文注释和文档字符串
- 遵循PEP 8编码规范
- 使用类型提示（Type Hints）
- 函数和类名使用英文，注释使用中文
- 变量名使用下划线命名法（snake_case）

### 2. 架构原则
- 严格遵循分层架构：API层 → 服务层 → CRUD层 → 模型层
- 使用依赖注入模式
- 单一职责原则：每个模块只负责一个功能
- 避免循环导入

### 3. 数据库操作
- 使用SQLAlchemy ORM进行数据库操作
- 所有数据库操作必须通过CRUD层
- 使用Alembic进行数据库迁移
- 数据库连接使用会话管理，确保正确关闭连接

### 4. API设计
- 遵循RESTful API设计原则
- 使用FastAPI的依赖注入系统
- 统一的错误处理和响应格式
- 使用Pydantic进行请求/响应验证

### 5. 异步任务
- 使用Celery处理长时间运行的任务
- 任务文件放在`app/tasks/`目录下
- 使用Redis作为消息代理

### 6. MQTT通信
- 所有MQTT相关操作通过`mqtt_service`
- 主题命名规范：`device/{device_id}/{message_type}`
- 消息格式使用JSON

### 7. 配置管理
- 所有配置通过`app/core/config.py`中的Settings类管理
- 敏感信息使用环境变量
- 支持多环境配置（dev/test/prod）

## 开发指南

### 1. 添加新功能
1. 在`app/db/models/`中定义数据库模型
2. 在`app/schemas/`中定义Pydantic模型
3. 在`app/crud/`中实现数据访问逻辑
4. 在`app/services/`中实现业务逻辑
5. 在`app/api/v1/endpoints/`中实现API端点
6. 在`app/api/v1/api.py`中注册路由

### 2. 数据库迁移
```bash
# 生成迁移文件
alembic revision --autogenerate -m "描述变更"

# 执行迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

### 3. 测试
- 单元测试放在`test/unit/`目录
- API测试放在`test/api/`目录
- 使用pytest作为测试框架

### 4. 部署
- 使用Docker容器化部署
- 通过docker-compose.yml管理多服务
- 支持开发、测试、生产环境

## 安全要求
- 所有API端点需要适当的认证和授权
- 使用JWT进行身份验证
- 密码使用bcrypt加密
- 敏感数据不能硬编码在代码中

## 性能要求
- 数据库查询使用索引优化
- 使用Redis缓存频繁访问的数据
- 异步处理长时间运行的任务
- 合理使用数据库连接池

## 错误处理
- 使用统一的异常处理机制
- 记录详细的错误日志
- 返回用户友好的错误信息
- 区分系统错误和业务错误

## 日志规范
- 使用Python标准logging模块
- 日志级别：DEBUG、INFO、WARNING、ERROR、CRITICAL
- 记录关键操作和错误信息
- 日志格式统一，包含时间戳、级别、模块、消息

## 代码质量
- 函数长度不超过50行
- 类长度不超过200行
- 文件长度不超过300行
- 圈复杂度不超过10
- 代码重复率低于5%

## 文档要求
- 所有公共API必须有文档字符串
- 复杂的业务逻辑必须有注释
- 更新代码时同步更新相关文档
- 使用中文编写用户文档

## 版本控制
- 使用Git进行版本控制
- 提交信息使用中文，格式：`类型: 简短描述`
- 分支命名：`feature/功能名`、`bugfix/问题描述`、`hotfix/紧急修复`
- 重要功能必须经过代码审查

## 环境配置
- 开发环境：localhost，调试模式开启
- 测试环境：独立数据库，模拟数据
- 生产环境：安全配置，性能优化

## 监控和运维
- 实现健康检查端点
- 监控MQTT连接状态
- 记录关键业务指标
- 设置告警机制

## 禁止事项
- 不要在代码中硬编码敏感信息
- 不要直接操作数据库，必须通过CRUD层
- 不要在API层直接处理业务逻辑
- 不要忽略异常处理
- 不要在生产环境使用调试模式
- 不要提交包含密码或密钥的代码

## 最佳实践
- 优先使用现有代码和模式，避免重复实现
- 保持代码简洁和可读性
- 及时重构过长的函数和类
- 编写单元测试覆盖核心功能
- 定期更新依赖包版本
- 使用代码格式化工具保持代码风格一致
