# Kong API Gateway 声明式配置
# 用于IoT微服务架构的统一API网关

_format_version: "3.0"
_transform: true

# 服务定义
services:
  # Auth Service - 认证授权服务
  - name: auth-service
    url: http://auth-service:8101
    protocol: http
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: auth-routes
        paths:
          - /api/v1/auth
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: true
      - name: users-routes
        paths:
          - /api/v1/users
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: true
      - name: roles-routes
        paths:
          - /api/v1/roles
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: true
      - name: permissions-routes
        paths:
          - /api/v1/permissions
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: true

  # Device Service - 设备管理服务
  - name: device-service
    url: http://device-service:8102
    protocol: http
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: devices-routes
        paths:
          - /api/v1/devices
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: true
      - name: device-data-routes
        paths:
          - /api/v1/device-data
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: true
      - name: device-commands-routes
        paths:
          - /api/v1/device-commands
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: true

  # Firmware Service - 固件管理服务
  - name: firmware-service
    url: http://firmware-service:8103
    protocol: http
    connect_timeout: 60000
    write_timeout: 120000  # 固件上传需要更长超时
    read_timeout: 120000
    retries: 3
    routes:
      - name: firmware-routes
        paths:
          - /api/v1/firmware
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: true
      - name: firmware-files-routes
        paths:
          - /files
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: true

# 全局插件
plugins:
  # CORS插件 - 跨域资源共享
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
        - X-Request-ID
      exposed_headers:
        - X-Auth-Token
        - X-Request-ID
      credentials: true
      max_age: 3600

  # 请求大小限制
  - name: request-size-limiting
    config:
      allowed_payload_size: 100  # MB，用于固件上传

  # 请求限流
  - name: rate-limiting
    config:
      minute: 1000
      hour: 10000
      policy: local
      fault_tolerant: true

  # 日志记录
  - name: file-log
    config:
      path: /tmp/kong/access.log
      reopen: true

# 上游健康检查配置
upstreams:
  - name: auth-upstream
    targets:
      - target: auth-service:8101
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 5
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3

  - name: device-upstream
    targets:
      - target: device-service:8102
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 5
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3

  - name: firmware-upstream
    targets:
      - target: firmware-service:8103
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 5
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3
